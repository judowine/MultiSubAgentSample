# Task 3.7: ProfileEditScreen Implementation

## Context
EventMeet project, PBI-1: User Profile Management Foundation (Task 7 of 9)

## Objective
Implement profile editing screen that allows users to modify their connpass ID and nickname.

## Dependencies Available
1. **User Domain Model**: `/Users/shota-kuroda/KotlinMultiplatformProject/MultiSubAgentSample/shared/src/commonMain/kotlin/org/example/project/judowine/domain/model/User.kt`
   - Properties: id, connpassId, nickname, createdAt, updatedAt
   - Method: `updateNickname(newNickname: String, updatedAt: Instant): User`

2. **UiState Pattern**: `/Users/shota-kuroda/KotlinMultiplatformProject/MultiSubAgentSample/composeApp/src/commonMain/kotlin/org/example/project/judowine/ui/common/UiState.kt`
   - Sealed interface with Loading, Success<T>, Error states
   - Use `UiState<User>` for state management

3. **GetUserProfileUseCase**: `/Users/shota-kuroda/KotlinMultiplatformProject/MultiSubAgentSample/shared/src/commonMain/kotlin/org/example/project/judowine/domain/usecase/GetUserProfileUseCase.kt`
   - Method: `suspend fun getPrimaryUser(): User?`

4. **SaveUserProfileUseCase**: `/Users/shota-kuroda/KotlinMultiplatformProject/MultiSubAgentSample/shared/src/commonMain/kotlin/org/example/project/judowine/domain/usecase/SaveUserProfileUseCase.kt`
   - Method: `suspend fun updateUserProfile(user: User, newNickname: String? = null): Result<User>`
   - Method: `suspend fun saveOrUpdateUserProfile(connpassId: String, nickname: String, existingUserId: Long? = null): Result<User>`

## Established Patterns to Follow

### 1. Screen/Content Separation Pattern
- **Stateful Screen Component**: Manages state, use case calls, effects
- **Stateless Content Component**: Pure presentation, emits events via callbacks

### 2. UiState<T> Pattern
- Use `UiState<User>` for loading states
- Loading → Success → (on save) Loading → Success/Error transitions

### 3. Material3 Design
- Card-based layouts with `MaterialTheme.colorScheme.surfaceVariant`
- `OutlinedTextField` for input fields
- Button with loading states (`CircularProgressIndicator` inside Button)
- Consistent spacing: 24.dp padding, 16.dp horizontal padding, 32.dp section spacing

## Implementation Requirements

### File Location
`/Users/shota-kuroda/KotlinMultiplatformProject/MultiSubAgentSample/composeApp/src/commonMain/kotlin/org/example/project/judowine/ui/screen/profile/ProfileEditScreen.kt`

### Functional Requirements
1. Load existing user profile on screen initialization using `GetUserProfileUseCase`
2. Pre-populate input fields with current connpassId and nickname
3. Allow user to modify both fields (editable text fields)
4. Validate inputs (non-empty for both fields)
5. Save button:
   - Disabled when fields are empty OR unchanged from original values
   - Shows loading indicator during save operation
   - Calls `SaveUserProfileUseCase.saveOrUpdateUserProfile()` on click
6. Show success/error states after save
7. Navigation: Return to profile display screen after successful save (via callback)

### Component Structure
```kotlin
@Composable
fun ProfileEditScreen(
    getUserProfileUseCase: GetUserProfileUseCase,
    saveUserProfileUseCase: SaveUserProfileUseCase,
    onEditSuccess: () -> Unit,
    onNavigateBack: () -> Unit = {},
    modifier: Modifier = Modifier
) {
    // State management with UiState<User>
    // LaunchedEffect to load user on initialization
    // Delegate to ProfileEditContent
}

@Composable
fun ProfileEditContent(
    state: UiState<User>,
    connpassId: String,
    nickname: String,
    isLoading: Boolean,
    isSaveEnabled: Boolean,
    errorMessage: String?,
    onConnpassIdChange: (String) -> Unit,
    onNicknameChange: (String) -> Unit,
    onSaveClick: () -> Unit,
    onBackClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    // Stateless presentation
    // Handle Loading/Success/Error states
}
```

### State Management Strategy (Temporary)
- Use `remember { mutableStateOf() }` for temporary state (will be refactored to ViewModel in Task 3.8)
- Track:
  - `loadState: UiState<User>` - user loading state
  - `connpassId: String` - current connpassId input
  - `nickname: String` - current nickname input
  - `isSaving: Boolean` - save operation in progress
  - `errorMessage: String?` - save error message
- Derived state:
  - `isSaveEnabled`: true if fields are non-empty AND different from original user values

### Error Handling
- Show loading state while fetching user
- Show error state if user not found
- Show inline error message if save fails
- Validation errors displayed immediately

### Navigation
- Back button in UI → calls `onNavigateBack()`
- Successful save → calls `onEditSuccess()` (parent handles navigation)

## Acceptance Criteria
- [ ] Screen loads existing user profile and pre-populates fields
- [ ] User can modify connpassId and nickname
- [ ] Save button is disabled when fields are empty
- [ ] Save button is disabled when fields are unchanged
- [ ] Save button shows loading indicator during save operation
- [ ] Success navigation after successful save
- [ ] Error message is displayed if save fails
- [ ] Build passes with `./gradlew build`

## Architecture Context
- Module: `/composeApp` (UI layer)
- Package: `org.example.project.judowine.ui.screen.profile`
- Pattern: Screen/Content separation (MVI will be formalized in Task 3.8)
- Design System: Material3 with established styling
- Dependencies: composeApp → shared (domain) - NO direct data layer access

## Review Awareness
This implementation will be reviewed by:
- codebase-knowledge-manager (pattern analysis)
- tech-lead-architect (architecture review)

Both reviews will run in parallel after implementation.
